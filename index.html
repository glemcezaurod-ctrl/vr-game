<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Glock VR - Spatial Room</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; display: flex; touch-action: none; }
        #input_video { display: none; }
        .eye { width: 50vw; height: 100vh; }
        #ui { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10000; background: #111; display: flex; 
            flex-direction: column; justify-content: center; align-items: center; 
            color: white; font-family: sans-serif; text-align: center; 
        }
        .btn { 
            padding: 20px 50px; font-size: 1.5rem; border: none; 
            border-radius: 10px; background: #0077ff; color: white; cursor: pointer; 
        }
    </style>
</head>
<body>

    <div id="ui">
        <h1>GLOCK VR: THE ROOM</h1>
        <p>Включите автоповорот и держите телефон горизонтально.<br>Правая рука (ОК) - движение, Левая (ОК) - затвор.</p>
        <button class="btn" id="start_btn">ВОЙТИ В СИСТЕМУ</button>
    </div>

    <video id="input_video" playsinline muted></video>
    <div id="left" class="eye"></div>
    <div id="right" class="eye"></div>

    <script>
        const videoElement = document.getElementById('input_video');
        const eyeConfigs = [];
        let currentYaw = 0, currentPitch = 0, walking = false;
        const playerPos = new THREE.Vector3(0, 1.6, 0);

        function initEye(id, isRightEye) {
            const container = document.getElementById(id);
            const scene = new THREE.Scene();
            
            const camera = new THREE.PerspectiveCamera(75, (window.innerWidth/2)/window.innerHeight, 0.1, 100);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth/2, window.innerHeight);
            container.appendChild(renderer.domElement);

            // --- КОМНАТА ---
            const roomSize = 15;
            const roomGeom = new THREE.BoxGeometry(roomSize, roomSize, roomSize);
            const materials = [
                new THREE.MeshStandardMaterial({ color: 0x333333, side: THREE.BackSide }), // право
                new THREE.MeshStandardMaterial({ color: 0x333333, side: THREE.BackSide }), // лево
                new THREE.MeshStandardMaterial({ color: 0x111111, side: THREE.BackSide }), // потолок
                new THREE.MeshStandardMaterial({ color: 0x222222, side: THREE.BackSide }), // пол
                new THREE.MeshStandardMaterial({ color: 0x444444, side: THREE.BackSide }), // перед
                new THREE.MeshStandardMaterial({ color: 0x444444, side: THREE.BackSide })  // зад
            ];
            const room = new THREE.Mesh(roomGeom, materials);
            room.position.y = roomSize / 2;
            scene.add(room);

            // Ориентиры (колонны)
            for(let i=0; i<6; i++) {
                const col = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 5), new THREE.MeshStandardMaterial({color: 0x990000}));
                const angle = (i / 6) * Math.PI * 2;
                col.position.set(Math.cos(angle)*5, 2.5, Math.sin(angle)*5);
                scene.add(col);
            }

            scene.add(new THREE.AmbientLight(0xffffff, 0.4));
            const light = new THREE.PointLight(0xffffff, 0.7);
            light.position.set(0, 5, 0);
            scene.add(light);

            // Модель пистолета (базовая геометрия)
            const gunGroup = new THREE.Group();
            scene.add(gunGroup);
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.1, 0.2), new THREE.MeshStandardMaterial({color: 0x151515}));
            gunGroup.add(body);
            const slide = new THREE.Mesh(new THREE.BoxGeometry(0.045, 0.04, 0.2), new THREE.MeshStandardMaterial({color: 0x252525}));
            slide.position.y = 0.07;
            gunGroup.add(slide);

            return { scene, camera, renderer, gunGroup, slide };
        }

        eyeConfigs.push(initEye('left', false), initEye('right', true));

        function onResults(results) {
            const hands = results.multiHandLandmarks;
            walking = false;

            if (hands && hands.length > 0) {
                hands.forEach((lm, index) => {
                    const x = (lm[8].x - 0.5) * 2;
                    const y = (0.5 - lm[8].y) * 2;
                    const isOk = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y) < 0.05;

                    if (index === 0) { // Ведущая рука (Пистолет)
                        eyeConfigs.forEach(ec => {
                            const handOffset = new THREE.Vector3(x + 0.3, y - 0.2, -0.6);
                            handOffset.applyQuaternion(ec.camera.quaternion);
                            ec.gunGroup.position.copy(ec.camera.position).add(handOffset);
                            ec.gunGroup.quaternion.copy(ec.camera.quaternion);
                        });
                        if (isOk) walking = true;
                    } else { // Левая рука (Взаимодействие)
                        eyeConfigs.forEach(ec => {
                            if (isOk) ec.slide.position.z = 0.06;
                            else ec.slide.position.z = 0;
                        });
                    }
                });
            }

            eyeConfigs.forEach((c, i) => {
                c.camera.rotation.set(currentPitch, currentYaw, 0, 'YXZ');
                if (walking) {
                    const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(c.camera.quaternion);
                    playerPos.addScaledVector(dir, 0.06);
                }
                c.camera.position.copy(playerPos);
                c.camera.position.x += (i === 0 ? -0.035 : 0.035); 
                c.renderer.render(c.scene, c.camera);
            });
        }

        const handsMP = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        handsMP.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6 });
        handsMP.onResults(onResults);

        const cameraHelper = new Camera(videoElement, {
            onFrame: async () => { await handsMP.send({image: videoElement}); },
            facingMode: 'environment', width: 640, height: 480
        });

        document.getElementById('start_btn').onclick = async () => {
            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                await DeviceOrientationEvent.requestPermission();
            }
            window.addEventListener('deviceorientation', (e) => {
                currentYaw = THREE.MathUtils.degToRad(e.alpha || 0);
                currentPitch = THREE.MathUtils.degToRad((e.beta || 90) - 90);
            }, true);
            
            await cameraHelper.start();
            document.getElementById('ui').style.display = 'none';
        };
    </script>
</body>
</html>
